<!DOCTYPE html>
<html>
<head>
  <title>Medical Chatbot</title>
  <!-- Load jQuery FIRST -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Then Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" crossorigin="anonymous">

  <!-- Your CSS -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}"/>

 <style>
  /* 游꿗 Active mic effect */
  #micBtn.active {
    background-color: #28a745 !important;
    color: white;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
  }

  /* Remove border highlight when clicked */
  #micBtn:focus,
  #send:focus {
    outline: none !important;
    box-shadow: none !important;
  }
</style>

</head>

<body>
  <div class="container-fluid h-100">
    <div class="row justify-content-center h-100">		
      <div class="col-md-8 col-xl-6 chat">
        <div class="card">
          <div class="card-header msg_head">
            <div class="d-flex bd-highlight">
              <div class="img_cont">
                <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img">
                <span class="online_icon"></span>
              </div>
              <div class="user_info">
                <span>Medical Chatbot</span>
                <p>Ask me anything!</p>
              </div>
            </div>
          </div>
          <div id="messageFormeight" class="card-body msg_card_body"></div>
          <div class="card-footer">
            <form id="messageArea" class="input-group">
              <input type="text" id="text" name="msg" placeholder="Type your message or use mic..." autocomplete="off" class="form-control type_msg" required/>
              <div class="input-group-append">
                <!-- 游꿗 Mic Button -->
                <button type="button" id="micBtn" class="input-group-text attach_btn">
                  <i class="fas fa-microphone"></i>
                </button>
                <!-- Send Button -->
                <button type="submit" id="send" class="input-group-text send_btn">
                  <i class="fas fa-location-arrow"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Listening Indicator -->
  <div id="listeningIndicator" 
    style="display:none; 
           position: fixed; 
           bottom: 120px; 
           left: 50%; 
           transform: translateX(-50%); 
           background: rgba(0,0,0,0.8); 
           color: white; 
           padding: 12px 20px; 
           border-radius: 20px; 
           font-size: 16px; 
           z-index: 1000;">
    游꿗 Listening...
  </div>

  <script>
    // 游릭 Speech-to-Text with Listening UI
    const micBtn = document.getElementById("micBtn");
    const textInput = document.getElementById("text");
    const listeningIndicator = document.getElementById("listeningIndicator");
    let recognition, micTimeout;

    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true; // allow interim results
      recognition.lang = "en-US";
      recognition.running = false;

      micBtn.addEventListener("click", () => {
        console.log("Mic clicked...");
        if (!recognition.running) {
          try {
            recognition.start();
            recognition.running = true;
            console.log("Recognition started.");
            listeningIndicator.style.display = "block";
            micBtn.classList.add("active"); // 游댮 highlight when recording
          } catch (err) {
            console.error("Recognition start error:", err);
          }

          micTimeout = setTimeout(() => {
            if (recognition.running) {
              console.log("Timeout reached, stopping recognition.");
              recognition.stop();
            }
          }, 5000);
        }
      });

      recognition.onresult = function(event) {
        let lastResult = event.results[event.results.length - 1];
        if (lastResult.isFinal) {
          const speechToText = lastResult[0].transcript;
          console.log("Final recognised speech:", speechToText);
          textInput.value = speechToText;

          // Auto-submit if something was spoken
          if (speechToText && speechToText.trim() !== "") {
            $("#messageArea").submit();
          }
        }
      };

      recognition.onspeechend = () => {
        console.log("Speech ended by user.");
        recognition.stop();
      };

      recognition.onend = () => {
        recognition.running = false;
        listeningIndicator.style.display = "none";
        clearTimeout(micTimeout);
        micBtn.classList.remove("active"); // 游릭 remove highlight
      };

      recognition.onerror = function(event) {
        console.error("Speech recognition error:", event.error);
        recognition.running = false;
        listeningIndicator.style.display = "none";
        clearTimeout(micTimeout);
        micBtn.classList.remove("active"); // 游릭 remove highlight
      };
    } else {
      alert("Speech Recognition not supported in this browser.");
    }

    // 游릭 Text-to-Speech (AI speaks response)
    function speakText(text) {
      const speech = new SpeechSynthesisUtterance(text);
      speech.rate = 1; // normal speed
      speech.pitch = 1;
      speech.volume = 1;
      speech.lang = "en-US";
      window.speechSynthesis.speak(speech);
    }

    // 游릭 Chat handling
    $(document).ready(function() {
      $("#messageArea").on("submit", function(event) {
        event.preventDefault();

        const date = new Date();
        const hour = date.getHours();
        const minute = date.getMinutes();
        const str_time = hour + ":" + minute;
        var rawText = $("#text").val().trim();

        if (rawText === "") return;

        var userHtml = '<div class="d-flex justify-content-end mb-4"><div class="msg_cotainer_send">'
          + rawText + '<span class="msg_time_send">' + str_time + '</span></div>'
          + '<div class="img_cont_msg"><img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg"></div></div>';

        $("#text").val("");
        $("#messageFormeight").append(userHtml);

        $.ajax({
          data: { msg: rawText },
          type: "POST",
          url: "/get",
        }).done(function(data) {
          let finalResponse = data && data.trim() !== "" 
            ? data 
            : "The text was not recognisable by Gemini.";

          // Escape response safely
          var safeData = $("<div>").text(finalResponse).html();
          var botHtml = '<div class="d-flex justify-content-start mb-4">'
            + '<div class="img_cont_msg"><img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg"></div>'
            + '<div class="msg_cotainer">' + safeData
            + '<span class="msg_time">' + str_time + '</span></div></div>';

          $("#messageFormeight").append(botHtml);

          // 游릭 AI speaks response
          speakText(finalResponse);
        });
      });
    });
  </script>
</body>
</html>
